<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¹ì‹  ì§‘ì—ì„œ ì˜ ìˆ˜ ìˆë‚˜ìš”? | ì‹œì²­ì ê³µë™ ì¼ê¸°ì¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Firebase -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #fff;
            overscroll-behavior: none;
        }
        .handwriting {
            font-family: 'Gaegu', cursive;
        }
        
        @keyframes soft-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animate-gradient-bg {
            /* Lisbon Sunset Vibe */
            background: linear-gradient(-45deg, #fff1f2, #fff7ed, #e0f2fe, #fdf4ff);
            background-size: 300% 300%;
            animation: soft-gradient 20s ease infinite;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Paper Texture Effect */
        .paper-texture {
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="h-[100dvh] w-full flex justify-center relative text-slate-800 animate-gradient-bg overflow-hidden">

    <div id="root" class="relative z-10 w-full max-w-[480px] h-full bg-white/40 backdrop-blur-xl flex flex-col sm:border-x sm:border-white/40 shadow-2xl"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.appId = appId;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { PenTool, Send, MessageCircle, Heart, User, Tag, BookOpen } = lucide;

        // Tags based on the text content provided
        const TAGS = [
            { id: 'all', label: 'ì „ì²´ë³´ê¸°', color: 'bg-slate-100 text-slate-600' },
            { id: 'jaemark', label: 'ğŸ‘ ì¬í˜„Xë§ˆí¬ ğŸ¯', color: 'bg-sky-100 text-sky-600' },
            { id: 'jaewon', label: 'âœ’ï¸ ì¬ê²½Xì§€ì›', color: 'bg-indigo-100 text-indigo-600' },
            { id: 'eunniko', label: 'ğŸ­ ì€ì¬Xë‹ˆì½”', color: 'bg-pink-100 text-pink-600' },
            { id: 'tomjerry', label: 'ğŸ”¥ ì—°ë•Xì„ ìš°', color: 'bg-orange-100 text-orange-600' },
            { id: 'support', label: 'ë°©ì†¡ ì‘ì›', color: 'bg-green-100 text-green-600' },
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [nickname, setNickname] = useState("");
            const [selectedTag, setSelectedTag] = useState(TAGS[5]); // Default to Support
            const [filterTag, setFilterTag] = useState('all');
            const [isWriting, setIsWriting] = useState(false);
            const scrollRef = useRef(null);

            // Firebase Auth & Data Fetching
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await window.signInWithCustomToken(window.auth, __initial_auth_token);
                        } else {
                            await window.signInAnonymously(window.auth);
                        }
                    } catch (e) {
                        console.error("Auth error", e);
                    }
                };
                initAuth();

                const unsubscribeAuth = window.onAuthStateChanged(window.auth, (u) => {
                    setUser(u);
                });

                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!user) return;

                // Fetch public messages
                const q = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'guestbook_messages');
                
                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    const loadedMessages = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Client-side sorting (Newest first)
                    loadedMessages.sort((a, b) => {
                        const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                        const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                        return dateB - dateA;
                    });

                    setMessages(loadedMessages);
                }, (error) => {
                    console.error("Error fetching messages:", error);
                });

                return () => unsubscribe();
            }, [user]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!input.trim() || !nickname.trim()) {
                    alert("ë‹‰ë„¤ì„ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”!");
                    return;
                }

                try {
                    await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'guestbook_messages'), {
                        text: input,
                        nickname: nickname,
                        tag: selectedTag,
                        userId: user.uid,
                        createdAt: window.serverTimestamp(),
                        likes: 0
                    });
                    setInput("");
                    setIsWriting(false);
                } catch (err) {
                    console.error("Error adding document: ", err);
                    alert("ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            };

            const formatDate = (timestamp) => {
                if (!timestamp) return "";
                const date = timestamp.toDate();
                const now = new Date();
                const diff = (now - date) / 1000; // seconds

                if (diff < 60) return "ë°©ê¸ˆ ì „";
                if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
                return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
            };

            const filteredMessages = filterTag === 'all' 
                ? messages 
                : messages.filter(m => m.tag.id === filterTag);

            return (
                <div className="flex flex-col h-full w-full">
                    {/* Header */}
                    <header className="shrink-0 px-6 pt-6 pb-4 bg-white/70 backdrop-blur-md border-b border-white/50 z-20">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <span className="text-[10px] font-bold text-sky-600 tracking-widest uppercase mb-1 block border border-sky-200 bg-sky-50 rounded-full px-2 py-0.5 w-fit">
                                    tvM ON-AIR
                                </span>
                                <h1 className="text-xl font-black text-slate-800 leading-tight flex items-center gap-2">
                                    ì‹œì²­ì ê³µë™ ì¼ê¸°ì¥ <i data-lucide="book-open" className="w-5 h-5 text-slate-400"></i>
                                </h1>
                            </div>
                            <div className="flex flex-col items-end">
                                <span className="text-xs text-slate-400 font-medium handwriting">ì˜¤ëŠ˜ì˜ ê°ì •ì„ ê¸°ë¡í•˜ì„¸ìš”</span>
                            </div>
                        </div>
                        
                        {/* Filter Tags */}
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                            {TAGS.map(tag => (
                                <button
                                    key={tag.id}
                                    onClick={() => setFilterTag(tag.id)}
                                    className={`whitespace-nowrap px-3 py-1.5 rounded-xl text-xs font-bold transition-all duration-200 border handwriting text-sm
                                        ${filterTag === tag.id 
                                            ? 'bg-slate-800 text-white border-slate-800 shadow-md scale-105' 
                                            : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}
                                >
                                    {tag.label}
                                </button>
                            ))}
                        </div>
                    </header>

                    {/* Message List */}
                    <main className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar" ref={scrollRef}>
                        {filteredMessages.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-60 text-slate-400 space-y-3">
                                <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm">
                                    <span className="text-3xl">ğŸ“</span>
                                </div>
                                <p className="text-sm handwriting text-xl text-slate-500">
                                    ì•„ì§ ê¸°ë¡ëœ í˜ì´ì§€ê°€ ì—†ì–´ìš”.<br/>
                                    ì²« ë²ˆì§¸ ì´ì•¼ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!
                                </p>
                            </div>
                        ) : (
                            filteredMessages.map((msg) => (
                                <div key={msg.id} className="bg-white/80 rounded-xl p-5 shadow-sm border border-white/60 animate-slide-up hover:shadow-md transition-all duration-200 relative overflow-hidden group">
                                    {/* Paper Texture Overlay */}
                                    <div className="absolute inset-0 paper-texture opacity-30 pointer-events-none"></div>
                                    
                                    <div className="flex justify-between items-start mb-3 relative z-10">
                                        <div className="flex items-center gap-2">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-lg shadow-inner border border-white/50 ${msg.tag.color.replace('text', 'bg').replace('100', '50')}`}>
                                                {msg.tag.id === 'jaemark' ? 'ğŸ‘' : 
                                                 msg.tag.id === 'eunniko' ? 'ğŸ­' : 
                                                 msg.tag.id === 'jaewon' ? 'âœ’ï¸' :
                                                 msg.tag.id === 'tomjerry' ? 'ğŸ”¥' : 'ğŸ“º'}
                                            </div>
                                            <div>
                                                <p className="text-sm font-bold text-slate-800">{msg.nickname}</p>
                                                <span className={`text-[10px] px-1.5 py-0.5 rounded-md font-bold ${msg.tag.color} opacity-80`}>
                                                    {msg.tag.label}
                                                </span>
                                            </div>
                                        </div>
                                        <span className="text-[10px] text-slate-400 font-medium bg-slate-50 px-2 py-1 rounded-lg">{formatDate(msg.createdAt)}</span>
                                    </div>
                                    
                                    {/* Handwritten Style Text */}
                                    <div className="relative z-10 pl-1 border-l-2 border-slate-100">
                                        <p className="text-slate-700 text-lg leading-relaxed whitespace-pre-wrap break-keep handwriting">
                                            {msg.text}
                                        </p>
                                    </div>
                                </div>
                            ))
                        )}
                        <div className="h-24"></div> {/* Spacer for FAB */}
                    </main>

                    {/* Write Button (FAB) */}
                    <button
                        onClick={() => setIsWriting(true)}
                        className="absolute bottom-6 right-6 w-14 h-14 bg-slate-800 text-white rounded-full shadow-xl flex items-center justify-center hover:bg-slate-700 transition-transform hover:scale-105 active:scale-95 z-30 group"
                    >
                        <i data-lucide="pen-tool" className="w-6 h-6 group-hover:-translate-y-0.5 group-hover:translate-x-0.5 transition-transform"></i>
                    </button>

                    {/* Write Modal */}
                    {isWriting && (
                        <div className="absolute inset-0 z-40 bg-black/20 backdrop-blur-sm flex items-end sm:items-center justify-center">
                            <div className="bg-[#fdfbf7] w-full max-w-[480px] sm:rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up h-[85vh] sm:h-auto flex flex-col relative">
                                {/* Notebook Spring Decoration */}
                                <div className="absolute top-0 left-0 w-full h-4 bg-gradient-to-b from-slate-200/50 to-transparent sm:rounded-t-3xl pointer-events-none"></div>

                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 className="text-xl font-bold text-slate-800 handwriting text-2xl">ì˜¤ëŠ˜ì˜ ê¸°ë¡ âœï¸</h2>
                                        <p className="text-xs text-slate-400">ì´ ì´ì•¼ê¸°ëŠ” ëª¨ë‘ê°€ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                    </div>
                                    <button onClick={() => setIsWriting(false)} className="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 hover:text-slate-600 transition-colors">
                                        âœ•
                                    </button>
                                </div>

                                <form onSubmit={handleSubmit} className="flex flex-col gap-5 flex-1 overflow-y-auto no-scrollbar">
                                    {/* Nickname Input */}
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Writer</label>
                                        <input
                                            type="text"
                                            value={nickname}
                                            onChange={(e) => setNickname(e.target.value)}
                                            placeholder="ìµëª…ì˜ ì‹œì²­ì"
                                            className="w-full px-0 py-2 bg-transparent border-b-2 border-slate-200 focus:outline-none focus:border-slate-800 transition-all text-lg handwriting placeholder:text-slate-300"
                                            maxLength={10}
                                        />
                                    </div>

                                    {/* Tag Selection */}
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Topic</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {TAGS.filter(t => t.id !== 'all').map(tag => (
                                                <button
                                                    key={tag.id}
                                                    type="button"
                                                    onClick={() => setSelectedTag(tag)}
                                                    className={`px-3 py-3 rounded-xl text-xs font-bold transition-all border text-left handwriting text-base
                                                        ${selectedTag.id === tag.id 
                                                            ? `border-transparent ring-2 ring-offset-1 ${tag.color.replace('text', 'bg').replace('100', '500')} text-white ring-slate-200 shadow-md` 
                                                            : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}
                                                >
                                                    {tag.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Message Input - Lined Paper Style */}
                                    <div className="flex-1 flex flex-col min-h-[150px]">
                                        <label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Diary</label>
                                        <div className="relative flex-1 bg-white border border-slate-200 rounded-xl overflow-hidden">
                                            <textarea
                                                value={input}
                                                onChange={(e) => setInput(e.target.value)}
                                                placeholder="ì˜¤ëŠ˜ ë°©ì†¡ì—ì„œ ëŠë‚€ ê°ì •ì´ë‚˜, ì¶œì—°ìë“¤ì—ê²Œ ì „í•˜ê³  ì‹¶ì€ ì´ì•¼ê¸°ë¥¼ ì ì–´ì£¼ì„¸ìš”..."
                                                className="w-full h-full p-5 bg-[linear-gradient(transparent_23px,#e5e7eb_24px)] bg-[length:100%_24px] leading-[24px] focus:outline-none resize-none handwriting text-xl text-slate-700 placeholder:text-slate-300"
                                            ></textarea>
                                        </div>
                                    </div>

                                    <button
                                        type="submit"
                                        className="w-full py-4 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 transition-all shadow-lg flex items-center justify-center gap-2 mt-auto handwriting text-xl transform active:scale-95"
                                    >
                                        ê¸°ë¡ ë‚¨ê¸°ê¸° <i data-lucide="send" className="w-4 h-4"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Initialize Lucide icons
        setTimeout(() => {
            lucide.createIcons();
        }, 100);
    </script>
</body>
</html>
